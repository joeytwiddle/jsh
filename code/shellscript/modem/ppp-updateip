## This bit is a check to ensure we didn't already do an update for this IP
## Ideally we would like other puters on the net to tell us when our ip is wrong.  (By connecting to them and asking them presumably.)

IP=`ppp-getip`

LAST=/tmp/ppp-updateip.last

LASTIP=`cat "$LAST"`
if test "$LASTIP" = "$IP"
then
	echo "$0: Last time we did an update, ip $IP was the same, so skipping."
	exit 0
fi

## This bit is a check to ensure we didn't update already in the last 15 minutes.

if test -f "$LAST"
then

	NOW=/tmp/ppp-updateip.now
	touch "$NOW"

	if test ! -x "`which datediff`"
	then echo "$0: Couldn't find datediff - not trying to update ip." ; exit 3
	fi
	SECONDSSINCE=`datediff -secs -files "$LAST" "$NOW"`

	if test "$SECONDSSINCE" -lt 1000
	then

		X=`datediff -files "$LAST" "$NOW"`
		echo "$0: Trying to re-update too soon.  ($X < 15m ago.)"
		exit 1

	fi

fi

## Repeated at bottom =)
if ! touch "$LAST"
then echo "$0: Couldn't touch $LAST.  Not trying to update ip." ; exit 2
fi

FAIL=false

# dyndhs.org update (using hwi.ath.cx):
/root/ipcheck/doipcheck || FAIL=true

( sleep 10m ; killall noip ) &
# no-ip.org update (for a domain probably better left unmentioned!):
/root/noip_updater_v1.6/noip -c /root/noip_updater_v1.6/no-ip.conf || FAIL=true
# since it likes to detach, and daemon itself, I kill it =)

# # dhs.org for hwi.dyn.dhs.org:
# HOST="hwi"
# USER="joey0"
# PASS="changeme"
# 
# URL="http://members.dhs.org/nic/hosts"
# HOSTCMD="hostscmd=edit&hostscmdstage=2"
# TYPES="type=4&updatetype=Online"
# CLOAK="cloak=Y&cloak_title=cloak+title"
# REST="mx=psybertech.yi.org&offline_url=&submit=Update&domain=dyn.dhs.org&hostname=$HOST"
# 
# WHOLEURL="$URL?$HOSTCMD&$TYPES&$IP&$REST&$CLOAK"
# 
# echo "Updating IP to $IP"
# echo "Using following URL: $WHOLEURL"
# 
# # echo "Lynx can't handle terminal $TERM"
# # echo "NOT UPDATING IP!"
# echo "UPDATING IP!"
# env TERM=vt100 lynx -auth=$USER:$PASS -dump "$WHOLEURL"

if test "$FAIL" = "true"
then
	echo "ppp-updateip: failed!"
	exit 4
fi

( date && echo "$$IP" ) >> /home/joey/j/logs/iphistory.txt

echo "$IP" > "$LAST"
