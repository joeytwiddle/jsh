NEW=`jgettmp "new-$1"`
OLD=`jgettmp "old-$1"`

if test "$1" = -direct
then
	shift
	METHOD="$@"
else
	# EXECSH=`jgettmp jwatch-do-$1`
	# echo "$@" > $EXECSH
	## Better to preserve quotes:
	EXECSTR=""
	for X
	# do EXECSTR="$EXECSTR\"$X\" "
	do EXECSTR="$EXECSTR$X "
	done
	# echo "$EXECSTR" > $EXECSH
	# chmod a+x "$EXECSH"
	METHOD='echo "$EXECSTR" | sh'
fi

## TODO:
## Should really make this an option, so jwatch can be used by progs
## Then force the option in interactive sh with an alias =)
cursecyan
echo "### Just to check: (no aliases since run in sh)"
cursemagenta
# $EXECSH
# echo "$EXECSTR" | sh
eval "$METHOD"
cursecyan
echo "### End check; starting watch. ----------------------------- "
cursenorm

# $EXECSH > $NEW
# echo "$EXECSTR" | sh > $NEW
eval "$METHOD" > $NEW

if test "x$JWATCHCOMPCOM" = "x"; then
  # JWATCHCOMPCOM="jfc simple oneway"
  # JWATCHCOMPCOM="jfcsh"
  JWATCHCOMPCOM="monitorpscompcom"
fi

sleep 1

while [ true ]; do

	mv $NEW $OLD

	# $EXECSH > $NEW
	# echo "$EXECSTR" | sh > $NEW
	eval "$METHOD" > $NEW

	$JWATCHCOMPCOM $NEW $OLD

	sleep 5

	`breakonctrlc`

done

jdeltmp "$NEW" "$OLD" "$EXECSH"
