# jsh-depends-ignore: check new
# jsh-depends: cursecyan cursemagenta cursenorm jwatchcomp breakonctrlc jdeltmp jgettmp
if test "$1" = "" || test "$1" = --help
then
	echo "jwatch [ -oneway ] [ -quiet ] [ -delay <seconds> ] [ -direct ] ... <command>"
	echo "  Executes the given command every 5 seconds, and reports changed lines."
	echo "  -oneway: does not show dropped lines (red), only shows new lines (white)."
	echo "  -quiet:  does not do initial verbose command check" ## CONSIDER: alternatively, -verbose could be a recommended sh alias, and quiet the default
	echo "  -direct: executes the command inline rather than piping to a new sh"
	echo "  -delay:  pauses for given period between calls to <command> (defaults to 5s)"
	exit 1
fi

if test "$1" = -oneway
then ONEWAY="-oneway"; shift
fi

if test "$1" = -quiet
then QUIET=true; shift
fi

DELAY=5
if [ "$1" = -delay ]
then
	DELAY="$2"
	shift; shift
fi

if test "$1" = -direct
then
	shift
	METHOD="$@"
else
	## We no longer bother with file method:
	# EXECSH=`jgettmp jwatch-do-$1`
	# echo "$@" > $EXECSH
	## Better to preserve quotes:
	EXECSTR=""
	for X
	# do EXECSTR="$EXECSTR\"$X\" " ## why?!
	do EXECSTR="$EXECSTR$X "
	done
	# echo "$EXECSTR" > $EXECSH
	# chmod a+x "$EXECSH"
	## We default to pipe method:
	METHOD='echo "$EXECSTR" | sh'
fi

NEW=`jgettmp "new-$1"`
OLD=`jgettmp "old-$1"`

## Optionally, display the results once (in case user assumed aliases would work!)
if test ! "$QUIET"
then
	cursecyan
	echo "### Just to check: (no aliases since run in sh)"
	cursemagenta
	# $EXECSH
	# echo "$EXECSTR" | sh
	eval "$METHOD" | head -20
	cursecyan
	echo "### End check; starting watch. ----------------------------- "
	cursenorm
fi

if test ! "$JWATCHCOMPCOM";
then
  JWATCHCOMPCOM="jwatchcomp $ONEWAY"
fi

eval "$METHOD" > $NEW

sleep $DELAY

while [ true ]; do

	mv $NEW $OLD

	# $EXECSH > $NEW
	# echo "$EXECSTR" | sh > $NEW
	eval "$METHOD" > $NEW

	$JWATCHCOMPCOM $NEW $OLD

	sleep $DELAY
	## If we want jwatch to keep in time, ie. run exactly every 5 seconds,
	## then we could bg this sleep at the start with & and then wait here.
	## This assumes that the process takes < 5s to run.
	## If not, timing will be wrong, and jwatch will never sleep!
	## If the process is heavy, this could drain your system.
	## Hence the existing method is good as a default.

	## Not sure this really works:
	# `breakonctrlc`
	`breakonctrlc` || exit

done

jdeltmp "$NEW" "$OLD" "$EXECSH"
